# Component Functions — Messages Workspace (Updated 2025-10-22)

| Component | Purpose | Data Sources & Contracts | Behaviour & Edge Cases | Telemetry / QA Hooks |
| --- | --- | --- | --- | --- |
| `ChatThreadList` | Surface ordered list of conversations with unread counts, SLA timers, and channel badges for providers, admins, and support agents. | `GET /api/chat/threads?include=lastMessage,unreadCount,slaDueAt` (polling every 45s with ETag caching); websocket subscription `chat.thread.updated` when available. | Threads sort by `pinnedAt` > `slaDueAt` ascending > `lastMessageAt` descending. Overdue SLA triggers critical badge and aria-live announcement. Offline mode caches last 30 threads in IndexedDB (`chat_threads`) and displays reconnect banner with retry CTA. Quiet hours collapse SLA timers but preserve unread counts with tooltip copy referencing support rota. | `chat.thread.view`, `chat.thread.pin`, `chat.thread.unpin`, `chat.thread.search`, `chat.thread.filter`. QA selectors: `data-qa="thread-card"` per row, `data-qa="thread-sla"` for countdown. Accessibility: focus trap returns to selected thread when closing conversation panel. |
| `ChatWindow` | Display active conversation timeline with author avatar, message metadata, attachments, AI/system annotations, and escalation banners. | `GET /api/chat/threads/:id/messages?cursor=` for infinite scroll; SSE/websocket `chat.message.created`; attachments served via signed URLs. Moderation metadata arrives in message payload (`moderationFlag`, `aiGenerated`, `escalationLevel`). | Implements virtualised list with reverse chronological stacking and day dividers. When SSE fails, fallback polls every 20s with exponential backoff (max 5 min). Moderated message shows red border + tooltip linking to compliance doc. Attachments >25MB blocked client-side with inline error referencing KB article. Loading skeleton shown during hydration; error state exposes “Retry” button that replays last cursor. | `chat.message.view`, `chat.message.scroll_back`, `chat.attachment.preview`, `chat.moderation.review`. QA selectors: `data-qa="message-bubble"`, `data-qa="message-author"`. Accessibility: aria-live "polite" region for new inbound messages, focus moves to new message on keyboard shortcuts (`Ctrl+Shift+M`). |
| `ChatComposer` | Author messages with AI assist toggle, prompt history, emoji/upload controls, and compliance copy. | POST `/api/chat/messages` with `{ body, attachments, aiAssistEnabled }`; `POST /api/chat/threads/:id/ai-toggle` persists toggle; `/api/chat/messages/:id/retry` for failed sends. | Composer disables send when network offline, surfaces offline draft badge stored in IndexedDB `chat_drafts`. AI toggle requires explicit consent; first enable displays modal summarising moderation + retention rules and writes `chat.aiConsentAt`. AI assist suggestions fetched via `POST /api/chat/messages/assist` using Secrets Manager-backed key; fallback to canned suggestions when 503. Emoji picker keyboard-accessible; attachments capped at 5 per message with progress indicator. Error chips allow retry or revert to draft without losing attachments. | `chat.message.compose`, `chat.message.send`, `chat.ai.toggle`, `chat.ai.suggestion.accept`, `chat.message.retry`. QA selectors: `data-qa="composer-textarea"`, `data-qa="composer-ai-toggle"`, `data-qa="composer-send"`. Accessibility: ensures label/description for AI toggle, announces token usage in aria-live region, maintains 44px touch targets. |
| `NotificationDrawer` | Persistent panel aggregating chat, booking, compliance, and analytics alerts with acknowledgement and escalation actions. | `GET /api/chat/notifications?status=pending&channels=chat,ops` (poll every 45s; respect quiet hours via `X-Quiet-Hours` header). PATCH `/api/chat/notifications/:id/acknowledge`; POST `/api/chat/notifications/:id/escalate`. Websocket `notification.created` pushes urgent alerts. | Cards grouped by severity (`critical`, `warning`, `info`). Quiet hours collapse to info banner summarising deferred alerts with CTA “Resume alerts now”. Acknowledgement removes card and triggers toast, while escalation opens modal capturing note + escalation channel (Slack, Email, SMS). Drawer persists scroll state, exposes search/filter. Offline state displays cached acknowledgements with sync indicator. SLA countdown chips turn red at <15 minutes. | `chat.notification.view`, `chat.notification.ack`, `chat.notification.escalate`, `chat.notification.defer`. QA selectors: `data-qa="notification-card"`, `data-qa="notification-ack"`. Accessibility: aria-live "assertive" for critical alerts, keyboard trap within drawer with escape to close, high-contrast badges. |
| `AgoraSessionLauncher` | Manage voice/video session readiness, device checks, and PSTN fallback for chat participants. | `POST /api/chat/sessions` returns `{ token, channel, expiresAt, supportsPstn }`; GET `/api/chat/sessions/:id/status`; Agora Web SDK events (`onConnectionStateChange`, `onTokenPrivilegeWillExpire`). | Preflight modal runs device/mic/camera tests, shows network quality indicator fed by Agora stats. On token expiry warning, auto-refresh via `/sessions/:id/refresh`. If WebRTC blocked, PSTN fallback button reveals dial-in info from backend. Joining session logs participants, opens floating panel with mute/video controls. Session failure triggers retry suggestion + knowledge base link. | `chat.session.start`, `chat.session.end`, `chat.session.pstn`, `chat.session.device_check`. QA selectors: `data-qa="session-launch"`, `data-qa="session-preflight"`, `data-qa="session-pstn"`. Accessibility: keyboard shortcuts (`M` mute, `V` video), screen reader announcements for join/leave, focus ring on active control. |

All components reference styling tokens defined in `theme_personalisation_toolkit.md` and align with interaction guidance in `Function Design.md`. QA automation should reference `vitest.setup.js` mocks for Agora/OpenAI to keep deterministic results.
