# Pre-Update Fix Suggestions (v1.00)

1. **Lock down authentication, authorisation, and session lifecycle**
   - Remove the permissive JWT fallback, enforce issuer/audience/expiry validation, and enable structured security logging with correlation IDs so forged tokens are rejected decisively. (`backend-nodejs/src/services/sessionService.js`, `backend-nodejs/src/middleware/auth.js`)
   - Tighten CORS and Helmet policies to explicit allowlists, disable credential reflection for unknown origins, and gate header-based impersonation behind explicit test flags with runtime assertions. (`backend-nodejs/src/app.js`, `backend-nodejs/src/middleware/auth.js`)
   - Rebuild the React session layer to revalidate `/api/auth/me` on focus/interval, cryptographically sign persisted session payloads, and clear corrupted storage automatically; move persona unlock decisions to audited server APIs. (`frontend-reactjs/src/api/sessionClient.js`, `frontend-reactjs/src/hooks/useSession.js`, `frontend-reactjs/src/pages/DashboardHub.jsx`)
   - Replace the Flutter demo bootstrap with a production sign-in flow that exchanges credentials for refresh/access tokens, surfaces refresh failures to the UI, forbids plaintext storage when biometrics are unavailable, and differentiates demo credentials from production in storage/telemetry. (`flutter-phoneapp/lib/features/auth/presentation/auth_gate.dart`, `flutter-phoneapp/lib/features/auth/application/auth_token_controller.dart`, `flutter-phoneapp/lib/features/auth/data/auth_token_store.dart`)
   - Introduce provider onboarding APIs that grant personas server-side, audit unlock events, and drive the React dashboard to redirect denied users toward remediation instead of leaving them at dead ends. (`backend-nodejs/src/routes/index.js`, `frontend-reactjs/src/components/auth/ProviderProtectedRoute.jsx`, `frontend-reactjs/src/pages/DashboardHub.jsx`)

2. **Stabilise migrations and protect financial/communications data**
   - Split the finance and communications migrations into separately deployable units, wrap each in `sequelize.transaction()` (with retry/backoff), and add `IF EXISTS` guards to down migrations for enums and tables. (`backend-nodejs/src/database/migrations/20250325000000-payments-orchestration.js`, `backend-nodejs/src/database/migrations/20250327000000-create-communications-inbox-settings.js`)
   - Remove destructive cascades from ledger tables, enforce positive amount and valid currency constraints, introduce idempotency keys for webhook events, and create composite uniques for notification recipients to prevent duplicates. (`backend-nodejs/src/database/migrations/20250325000000-payments-orchestration.js`, `backend-nodejs/src/database/migrations/20250330001000-create-customer-notification-recipients.js`)
   - Seed deterministic bootstrap data (with fixed UUIDs) for communications inboxes and escalation rules, validate JSON columns against schemas, capture `created_by`/`updated_by` metadata for every privileged record, and document expected payloads for operators. (`backend-nodejs/src/database/migrations/20250327000000-create-communications-inbox-settings.js`)
   - Expand indexing on finance (`payout_requests.provider_id`, `finance_webhook_events.provider,status,next_retry_at`) and communications (`enabled` filtered indexes) to guarantee performant queries once live traffic arrives, and add conflict-handling strategies for webhook/event retries. (`backend-nodejs/src/database/migrations/20250325000000-payments-orchestration.js`)

3. **Repair platform bootstrapping and runtime resilience**
   - Deduplicate router mounts, ensure versioned routers are exposed only once, and convert `server.js` to export a `start()` function so tests, blue/green deployments, and CLI scripts can control listener lifecycle. (`backend-nodejs/src/routes/index.js`, `backend-nodejs/src/server.js`)
   - Defer secrets retrieval until after logging/metrics initialise, add exponential backoff + jitter, and fail gracefully with degraded modes instead of crashing during module import. (`backend-nodejs/src/config/index.js`, `backend-nodejs/src/app.js`)
   - Update readiness bootstraps to detect database capabilities rather than executing `CREATE EXTENSION`, provide actionable remediation, and ensure the rate limiter key generator tolerates missing headers while emitting proper `Retry-After` guidance. (`backend-nodejs/src/app.js`)
   - Gate background jobs behind feature flags or leader election, return `Retry-After` headers from rate limiting, and replace unconditional `process.exit` with cooperative shutdown hooks that respect in-flight requests. (`backend-nodejs/src/jobs/index.js`, `backend-nodejs/src/app.js`, `backend-nodejs/src/server.js`)
   - Break the React router into persona-specific bundles with nested Suspense boundaries, add onboarding redirects for unauthorised providers, throttle denial retries, and lazy-load heavy widgets (maps, chat) only when activated. (`frontend-reactjs/src/App.jsx`, `frontend-reactjs/src/components/auth/ProviderProtectedRoute.jsx`)
   - Parallelise Flutter bootstrap tasks, render a branded splash/loading indicator while secure storage initialises, persist the last-selected tab, add environment pickers for QA, and convert the navigation stack to demand-driven builders instead of an always-on `IndexedStack`. (`flutter-phoneapp/lib/app/bootstrap.dart`, `flutter-phoneapp/lib/app/app.dart`, `flutter-phoneapp/lib/core/config/app_config.dart`)

4. **Restore build viability, dependency governance, and developer ergonomics**
   - Rewrite `backend-nodejs/package.json` to valid JSON, remove duplicate keys, align dependency versions with stable releases (e.g., downgrade `bcrypt`, ensure MapLibre/Mapbox compatibility), and declare `engines` metadata for Node along with CommonJS/ESM entry points. (`backend-nodejs/package.json`)
   - Regenerate JavaScript and Flutter lockfiles using official tooling, add CI jobs that verify lockfiles match manifests, and wire `npm audit`/`scripts/security-audit.mjs` plus Flutter `flutter pub outdated` checks into pull-request validation. (`frontend-reactjs/package.json`, `frontend-reactjs/package-lock.json`, `flutter-phoneapp/pubspec.yaml`, `flutter-phoneapp/pubspec.lock`)
   - Document native build prerequisites (build-essential, Android SDK levels, biometric entitlements) and update onboarding guides so contributors can install dependencies without guesswork, including instructions for configuring secure storage and biometric plugins. (`docs/onboarding` or new README sections, `scripts/security-audit.mjs`, `flutter-phoneapp/pubspec.yaml`)
   - Guard optional tooling (`scripts/run-load-tests.mjs`, `k6`) with dependency detection, provide fallbacks or clear error messages, publish a dependency changelog/ADR for experimental upgrades (React 18.3, Vite 6), and codify Node runtime requirements across scripts. (`scripts/run-load-tests.mjs`, `scripts/security-audit.mjs`, `frontend-reactjs/package.json`, `backend-nodejs/package.json`)
   - Rationalise dashboard dependencies by removing duplicate Turf packages, validating MapLibre vs Mapbox Draw compatibility, and introducing bundle analysis tooling to monitor footprint. (`frontend-reactjs/package.json`, `frontend-reactjs/package-lock.json`)

5. **Implement observability, diagnostics, and support-ready error handling**
   - Build `/telemetry/client-errors` and `/telemetry/mobile-crashes` endpoints with authentication, quota controls, and retention policies; update web/mobile clients to await responses, include build metadata, and batch uploads. (`backend-nodejs/src/routes/telemetryRoutes.js`, `frontend-reactjs/src/utils/errorReporting.js`, `flutter-phoneapp/lib/core/diagnostics/app_diagnostics_reporter.dart`, `flutter-phoneapp/lib/main.dart`)
   - Replace user-facing stack traces with support-friendly error pages that show incident IDs, summarise what happened, and guide users toward recovery or contact channels; capture denial analytics for provider personas to inform onboarding improvements. (`frontend-reactjs/src/components/error/AppErrorBoundary.jsx`, `frontend-reactjs/src/components/error/RouteErrorBoundary.jsx`, `frontend-reactjs/src/components/auth/ProviderProtectedRoute.jsx`, `flutter-phoneapp/lib/app/app_failure_boundary.dart`)
   - Emit structured startup/shutdown logs, readiness/health metrics, and rate-limit counters to observability backends so SREs can track regressions and capacity planning. (`backend-nodejs/src/server.js`, `backend-nodejs/src/app.js`)
   - Enhance crash diagnostics to enforce HTTPS, await telemetry futures, capture device/locale/build flavour, differentiate demo vs production sessions, and redact sensitive payloads before transmission or logging. (`flutter-phoneapp/lib/core/diagnostics/app_diagnostics_reporter.dart`, `flutter-phoneapp/lib/main.dart`)
   - Instrument the dashboard and mobile app with route/performance telemetry, persona unlock events, and dependency health metrics so leadership can monitor rollout readiness. (`frontend-reactjs/src/App.jsx`, `frontend-reactjs/src/pages/DashboardHub.jsx`, `flutter-phoneapp/lib/app/app.dart`)

6. **Re-focus roadmap scope and governance checkpoints**
   - Sequence the release to deliver authentication hardening, booking stability, and telemetry visibility before re-introducing finance/provider expansions; document the staged rollout plan for leadership sign-off. (`backend-nodejs/src/routes/index.js`, `frontend-reactjs/src/App.jsx`, `flutter-phoneapp/lib/app/app.dart`, roadmap docs)
   - Establish a cross-functional approval checklist covering security review, migration dry runs, dependency audits, and telemetry readiness prior to promoting builds to release candidates. (`docs/updates/1.00/pre-update_evaluations/issue_report.md`, program management templates)
   - Track each remediation workstream in shared tooling (Jira/Linear) with owners, due dates, and acceptance criteria so critical fixes do not get lost among lower-priority enhancements, and ensure dependency/telemetry guardrails are codified as release gates. (Program governance)
